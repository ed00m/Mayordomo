<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Configuración del núcleo (kernel)</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.64
"><LINK
REL="HOME"
TITLE="Tutorial de IPtables 1.1.19es"
HREF="index.html"><LINK
REL="UP"
TITLE="Preparativos"
HREF="c93.html"><LINK
REL="PREVIOUS"
TITLE="Preparativos"
HREF="c93.html"><LINK
REL="NEXT"
TITLE="Configuración de la zona de usuario"
HREF="x262.html"></HEAD
><BODY
CLASS="SECTION"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Tutorial de IPtables 1.1.19es</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="c93.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 2. Preparativos</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x262.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="KERNELSETUP"
>2.2. Configuración del núcleo (kernel)</A
></H1
><P
>Para ejecutar lo más básico de <B
CLASS="COMMAND"
>iptables</B
> tienes que configurar
las siguientes opciones en el núcleo mientras ejecutas <B
CLASS="COMMAND"
>make config</B
>
o uno de sus comandos relacionados:
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_PACKET</TT
> - Esta opción permite que las
aplicaciones y las utilidades que lo necesiten puedan trabajar directamente con
distintos periféricos de red. Ejemplos de estas utilidades son tcpdump o
snort.
   </P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="images/note.gif"
HSPACE="5"
ALT="Note"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>En sentido estricto, CONFIG_PACKET no es necesario para que iptables funcione,
pero puesto que tiene tantos usos diferentes, he decidido incluirlo. Si crees
que no lo necesitas, no lo incluyas.
    </P
></TD
></TR
></TABLE
></DIV
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_NETFILTER</TT
> - Esta opción se requiere
cuando vas a utilizar tu ordenador como cortafuegos o como puerta de enlace
(gateway) con Internet. En otras palabras, es imprescindible para que funcione
cualquier cosa de las que se explican en este tutorial. Entiendo que éso es lo
que deseas, ya que estás leyendo el tutorial.
   </P
><P
>Y, por supuesto, necesitas añadir los controladores (drivers) necesarios para
que tus interfases funcionen correctamente, es decir, el adaptador Ethernet y
las interfases <SPAN
CLASS="SYSTEMITEM"
>PPP</SPAN
> y <SPAN
CLASS="SYSTEMITEM"
>SLIP</SPAN
>.
Todo lo anterior sólo añade un poco de lo más básico de iptables. En realidad
no serás capaz de hacer nada realmente productivo, ya que sólo añade la
estructura básica al núcleo. Si quieres utilizar las opciones más avanzadas de
iptables, tendrás que configurar las opciones necesarias en el núcleo. A
continuación te mostraré las opciones disponibles en una versión 2.4.9 básica
del núcleo y las explicaré brevemente:
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_CONNTRACK</TT
> - Este módulo es
necesario para efectuar el seguimiento de las conexiones. El seguimiento de las
conexiones lo emplean, entre otros, la traducción de direcciones (<SPAN
CLASS="SYSTEMITEM"
>NAT</SPAN
>)
y el enmascaramiento (<SPAN
CLASS="SYSTEMITEM"
>Masquerading</SPAN
>). Si necesitas
proteger con un cortafuegos las máquinas de una red local, definitivamente debes
marcar esta opción. Por ejemplo, este módulo lo necesita el script <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
> para funcionar.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_FTP</TT
> - Este módulo es necesario si
quieres hacer seguimiento de conexiones en las conexiones <SPAN
CLASS="SYSTEMITEM"
>FTP</SPAN
>.
Puesto que estas conexiones son bastante difíciles de monitorizar en condiciones
normales, el conntrack necesita lo que se denomina un asistente y esta opción lo
compila en el núcleo. Si no añades este módulo no serás capaz de hacer transferencias FTP
correctamente a través del cortafuegos o la puerta de enlace.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_IPTABLES</TT
> - Esta opción es
necesaria si quieres realizar algún tipo de filtrado, enmascaramiento
(<SPAN
CLASS="SYSTEMITEM"
>masquerading</SPAN
>) o traducción de direcciones
(<SPAN
CLASS="SYSTEMITEM"
>NAT</SPAN
>). Añade toda la estructura de identificación
de iptables al núcleo. Sin ésto, no serás capaz de hacer nada en absoluto con
iptables.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_LIMIT</TT
> - Este módulo no es
imprescindible, pero se emplea en el ejemplo <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
>. Esta opción añade la comparación LIMIT
(límite), ofreciendo la posibilidad de controlar el número de paquetes por
minuto que se deben comparar, gobernado por la regla adecuada. Por ejemplo,
con <B
CLASS="COMMAND"
>-m limit --limit 3/minute</B
> compararíamos un máximo de 3
paquetes por minuto. Mediante este módulo también podemos evitar ciertos ataques
de denegación de servicios (en inglés: Denial of Service attacks, DoS attacks).
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_MAC</TT
> - Este módulo nos
permite comparar paquetes basándonos en las direcciones físicas <SPAN
CLASS="SYSTEMITEM"
>MAC</SPAN
>:
cada adaptador de red Ethernet tiene su propia dirección <SPAN
CLASS="SYSTEMITEM"
>MAC</SPAN
>,
distinta a la de cualquier otro adaptador, aunque sea de la misma marca y modelo.
Así, por ejemplo podremos bloquear paquetes en función de la dirección
<SPAN
CLASS="SYSTEMITEM"
>MAC</SPAN
> utilizada y bloquear ordenadores concretos puesto que
la dirección <SPAN
CLASS="SYSTEMITEM"
>MAC</SPAN
> de esos ordenadores raramente cambia (ya
que raramente se sustituye el adaptador Ethernet por uno nuevo). No se utiliza
esta opción ni en el ejemplo <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
>
ni en ningún otro sitio.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_MARK</TT
> - Nos permite utilizar
la comparación <B
CLASS="COMMAND"
>MARK</B
>. Por ejemplo, podemos utilizar el
objetivo <B
CLASS="COMMAND"
>MARK</B
> para marcar paquetes, de forma que más
adelante se puedan comparar y filtrar paquetes dependiendo de si tienen la marca
o no. De hecho esta opción es la comparación <B
CLASS="COMMAND"
>MARK</B
> y más
adelante veremos el objetivo <B
CLASS="COMMAND"
>MARK</B
>.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_MULTIPORT</TT
> - Este módulo
permite que comparemos paquetes con un amplio rango de puertos de origen o de
destino. Normalmente ésto no sería posible, pero con este módulo sí lo es.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_TOS</TT
> - Con esta comparación
podemos comparar paquetes en base a su campo <SPAN
CLASS="SYSTEMITEM"
>TOS</SPAN
>, es
decir, su Tipo de Servicio (<I
CLASS="EMPHASIS"
>Type Of Service</I
>). El tipo de
servicio se puede establecer mediante determinadas reglas en la tabla
<SPAN
CLASS="SYSTEMITEM"
>mangle</SPAN
> y mediante los comandos ip/tc.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_TCPMSS</TT
> - Esta opción nos
ofrece la posibilidad de comparar los paquetes <SPAN
CLASS="SYSTEMITEM"
>TCP</SPAN
>
en función de su campo <SPAN
CLASS="SYSTEMITEM"
>MSS</SPAN
>.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_STATE</TT
> - Aquí tenemos una de
las mayores novedades respecto a <B
CLASS="COMMAND"
>ipchains</B
>. Con este módulo
podemos realizar comparaciones por flujos de paquetes (stateful matching).
Por ejemplo, si en una conexión <SPAN
CLASS="SYSTEMITEM"
>TCP</SPAN
> ya hemos visto
tráfico en dos direcciones, los paquetes que les sigan serán considerados como
<B
CLASS="COMMAND"
>ESTABLISHED</B
> (establecido), aplicándoles por éllo las mismas acciones que a
los paquetes que iniciaron el flujo. Este módulo se usa ampliamente en el
ejemplo <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
>.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_UNCLEAN</TT
> - Este módulo nos
brinda la posibilidad de comparar paquetes <SPAN
CLASS="SYSTEMITEM"
>IP</SPAN
>,
<SPAN
CLASS="SYSTEMITEM"
>TCP</SPAN
>, <SPAN
CLASS="SYSTEMITEM"
>UDP</SPAN
> e <SPAN
CLASS="SYSTEMITEM"
>ICMP</SPAN
>
que no cumplen con las normas o son inválidos. En condiciones normales se
desecharán estos paquetes, pero nunca sabremos si son legítimos o no. Además, ten
en cuenta que esta comparación todavía está en fase experimental y puede que no
funcione correctamente en todos los casos.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_MATCH_OWNER</TT
> - con esta opción
tendremos la oportunidad de comparar en base al propietario de la conexión. Por
ejemplo, podremos permitir acceso a Internet únicamente al usuario "root". Este
módulo se escribió para mostrar lo que se podía lograr con el nuevo
<B
CLASS="COMMAND"
>iptables</B
>. Ten en cuenta que esta comparación es experimental
y puede que no le funcione bien a todo el mundo.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_FILTER</TT
> - este módulo
añade la tabla <SPAN
CLASS="SYSTEMITEM"
>filter</SPAN
> básica que permitirá efectuar
el filtrado <SPAN
CLASS="SYSTEMITEM"
>IP</SPAN
>. En la tabla <SPAN
CLASS="SYSTEMITEM"
>filter</SPAN
>
encontraremos las cadenas <SPAN
CLASS="SYSTEMITEM"
>INPUT</SPAN
>, <SPAN
CLASS="SYSTEMITEM"
>FORWARD</SPAN
>
y <SPAN
CLASS="SYSTEMITEM"
>OUTPUT</SPAN
>. Este módulo es necesario si pretendemos hacer
algún tipo de filtrado en los paquetes que recibamos y/o enviemos.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_REJECT</TT
> -
este objetivo nos permite especificar que se debe enviar un mensaje de error
<SPAN
CLASS="SYSTEMITEM"
>ICMP</SPAN
> como respuesta a los mensajes entrantes, en lugar
de simplemente desecharlos e ignorarlos. Ten en cuenta que las conexiones
<SPAN
CLASS="SYSTEMITEM"
>TCP</SPAN
>, al contrario que las <SPAN
CLASS="SYSTEMITEM"
>ICMP</SPAN
>
y las <SPAN
CLASS="SYSTEMITEM"
>UDP</SPAN
>, siempre se reinician o rechazan con un
paquete <SPAN
CLASS="SYSTEMITEM"
>TCP RST</SPAN
>.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_MIRROR</TT
> -
sirve para permitir a los paquetes que sean devueltos ("rebotados") al remitente.
Por ejemplo, si configuramos un objetivo <SPAN
CLASS="SYSTEMITEM"
>MIRROR</SPAN
> en el
puerto de destino <SPAN
CLASS="SYSTEMITEM"
>HTTP</SPAN
>, en nuestra cadena
<SPAN
CLASS="SYSTEMITEM"
>INPUT</SPAN
>, y alguien intenta acceder a este puerto, le
devolveremos sus paquetes y como resultado probablemente acabará viendo su
propia pagina web inicial (homepage).
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_NAT</TT
> - este módulo permite que se
efectúe la traducción de dirección de red (<SPAN
CLASS="SYSTEMITEM"
>network address
translation</SPAN
>), o <SPAN
CLASS="SYSTEMITEM"
>NAT</SPAN
>, en sus diferentes
variantes. La opción nos da acceso a la tabla nat en iptables y es necesaria si
queremos hacer reenvío a puertos (port forwarding), enmascaramiento
(masquerading), etc. Ten en cuenta que esta opción no es imprescindible para el
cortafuegos y el enmascaramiento de una <SPAN
CLASS="SYSTEMITEM"
>LAN</SPAN
>, pero deberías
tenerlo activo a no ser que seas capaz de asignar direcciones IP únicas para
cada uno de los hosts. Así pues, esta opción es necesaria para que el script de
ejemplo <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
>
funcione correctamente, y es ciertamente imprescindible si no puedes asignar
direcciones IP únicas a cada host.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_MASQUERADE</TT
> - este módulo
añade el objetivo <B
CLASS="COMMAND"
>MASQUERADE</B
>. Por ejemplo, si no sabemos qué
dirección IP tenemos para conectar a Internet, ésta será la forma ideal de
conseguir la IP en vez de utilizar <SPAN
CLASS="SYSTEMITEM"
>DNAT</SPAN
> o <SPAN
CLASS="SYSTEMITEM"
>SNAT</SPAN
>.
En otras palabras, si utilizamos <SPAN
CLASS="SYSTEMITEM"
>DHCP</SPAN
>,
<SPAN
CLASS="SYSTEMITEM"
>PPP</SPAN
>, <SPAN
CLASS="SYSTEMITEM"
>SLIP</SPAN
> o cualquier otra
conexión que nos asigne una IP, necesitamos utilizar este objetivo en lugar de
<SPAN
CLASS="SYSTEMITEM"
>SNAT</SPAN
>. El enmascaramiento produce una carga en el
sistema algo mayor que <SPAN
CLASS="SYSTEMITEM"
>NAT</SPAN
>, pero funcionará sin que
necesitemos conocer previamente la dirección IP.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_REDIRECT</TT
> - este objetivo es
útil al emplearlo junto a <SPAN
CLASS="SYSTEMITEM"
>proxies de aplicación</SPAN
>, por
ejemplo. En vez de dejar simplemente que el paquete pase, lo remapeamos para
que se dirija a nuestra máquina local. En otras palabras, de esta forma
tenemos la posibilidad de crear un <SPAN
CLASS="SYSTEMITEM"
>proxy transparente</SPAN
>.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_LOG</TT
> - esta opción añade el
objetivo <B
CLASS="COMMAND"
>LOG</B
> y su funcionalidad a <B
CLASS="COMMAND"
>iptables</B
>.
Podemos utilizar este módulo para registrar determinados paquetes en el syslogd
y así ver qué les está pasando. Ésto sólo ya es inestimable de cara a
las auditorías de seguridad, forenses o de depuración de errores del script que
estés escribiendo.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_TARGET_TCPMSS</TT
> - esta opción se
puede emplear para evitar a los Proveedores de Servicios de Internet (ISPs) y a
los servidores que bloquean los paquetes "<SPAN
CLASS="SYSTEMITEM"
>ICMP Fragmentation Needed</SPAN
>".
Los efectos de esta acción pueden ser páginas web que no lleguen, pequeños
correos que sí lleguen mientras que los grandes no lo consigan, las conexiones
ssh funcionan pero las conexiones scp se pierden ("mueren") tras el saludo
inicial, ... En estos casos podemos utilizar el objetivo <SPAN
CLASS="SYSTEMITEM"
>TCPMSS</SPAN
>
para superar el problema ajustando nuestro <SPAN
CLASS="SYSTEMITEM"
>MSS</SPAN
> (tamaño
máximo de segmento) al <SPAN
CLASS="SYSTEMITEM"
>PMTU</SPAN
> (Path Maximum Transmit Unit,
unidad máxima de transmisión). De esta forma seremos capaces de trabajar con lo
que los autores de Netfilter llaman (en la ayuda para la configuración del kernel)
"criminally brain-dead ISPs or servers", algo así como "servidores o ISPs
absolutamente descerebrados".
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_COMPAT_IPCHAINS</TT
> - añade un modo de
compatibilidad con el obsoleto <B
CLASS="COMMAND"
>ipchains</B
>. No confíes en este
módulo como solución a largo plazo para resolver la migración de los núcleos 2.2
a los 2.4, ya que es probable que desaparezca con la llegada del núcleo 2.6.
   </P
><P
><TT
CLASS="COMPUTEROUTPUT"
>CONFIG_IP_NF_COMPAT_IPFWADM</TT
> - módulo de
compatibilidad con el obsoleto <B
CLASS="COMMAND"
>ipfwadm</B
>. Ni se te ocurra
recurrir a este módulo como solución a largo plazo.
   </P
><P
>Como puedes observar hay un buen puñado de opciones. Acabo de explicar
brevemente los tipos de comportamiento extras que puedes esperar con cada
módulo, aunque sólo se trata de las opciones disponibles en un núcleo 2.4.9
simple, sin ningún extra. Si quieres ver más opciones, te recomiendo que mires
las funciones existentes en el "<SPAN
CLASS="SYSTEMITEM"
>patch-o-matic</SPAN
>" (POM)
de la zona de usuario de <SPAN
CLASS="SYSTEMITEM"
>Netfilter</SPAN
>, pues encontrarás
montones de opciones extras para el núcleo. Los parches del <SPAN
CLASS="SYSTEMITEM"
>POM</SPAN
>
son opciones extra que supuestamente se añadirán al núcleo en el futuro, pero que
todavía no se han desarrollado lo suficiente como para añadírselos. Las razones
pueden ser variadas, como que el parche todavía no sea estable, o que Linus
Torvalds no pueda mantenerlo, o incluso que no quiera introducir el parche en
el desarrollo del núcleo por ser todavía experimental.
   </P
><P
>Necesitarás tener compiladas en el núcleo las opciones siguientes, o bien
tenerlas como módulos, para que el script <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
> pueda funcionar. Si necesitas ayuda acerca
del resto de opciones necesarias para los otros scripts, léete el capítulo sobre
los scripts de ejemplo.
   </P
><P
></P
><UL
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_PACKET
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_NETFILTER
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_CONNTRACK
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_FTP
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_IRC
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_IPTABLES
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_FILTER
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_NAT
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_MATCH_STATE
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_TARGET_LOG
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_MATCH_LIMIT
   </P
></LI
><LI
STYLE="list-style-type: opencircle"
><P
>   CONFIG_IP_NF_TARGET_MASQUERADE
   </P
></LI
></UL
><P
>Como mínimo necesitarás lo anterior para utilizar el script <A
HREF="x3746.html"
><I
>rc.firewall.txt</I
></A
>. Para el resto de
scripts explicaré lo que necesitan en sus respectivas secciones. Por el momento
intentemos centrarnos en el ejemplo principal.
   </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="c93.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x262.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Preparativos</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c93.html"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Configuración de la zona de usuario</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>